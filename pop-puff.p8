pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
rectfill(0,0,127,127,5)

tiles={}
players={}
tweens={}
board_rows=5
board_cols=5

function make_actor(tag,col,row,sprite)
	col=col or 0
	row=row or 0
	a={}
	a.col=col
	a.row=row
	a.x=col*8
	a.y=row*8
	a.spr=sprite
	a.tag=tag
	a.parent=nil
	return a
end

function attach(a,b)
	a.parent=b
	a.col=b.col
	a.row=b.row
	a.x=a.col*8
	a.y=a.row*8
	printh("5>>"..a.x..";"..a.y..";"..b.col..";"..b.row)
end

function tile_at(x,y)
	local index=((y-1)*(board_cols))+x
	return tiles[index]
end

function move_to(a,t)
	a.parent=nil
	attach(a,t)
end

function _init()
 local a;
 for row=1,board_rows do
	 for col=1,board_cols do
		 a=make_actor("tile",col,row,18)	
	 	add(tiles,a)
	 end
 end
 a=make_actor("player",1,1,1)
 add(players,a)
 
 attach(a,tile_at(3,3))

	c=make_actor("cake",1,1,3)
	attach(c,tile_at(1,4))
	add(players,c)
	printh(">>>>>>>>>>>>>>>")
	make_tween(c,"x",5*8,0.02)
	make_tween(c,"y",1*8,0.02)
end

function control_player(player_num,dx,dy)
	dx=dx or 0
	dy=dy or 0
	local a=players[player_num]
	local t=tile_at(a.parent.col+dx,a.parent.row+dy);
	printh("-1>>"..a.parent.col..";"..a.parent.row..";"..t.col..";"..t.row)
	local x_or_y=nil
	local to_use=nil
	if dx!=0 then
		x_or_y="x"
		to_use=t.x
	elseif dy!=0 then
		x_or_y="y"
		to_use=t.y
	end
	if t != nil then
		make_tween(a,x_or_y,to_use,0.1)
		printh("0>>"..t.col..","..t.row)
	end
end

function handle_tween(tween)
	if tween__handle_reached(tween) then
		return
	end	
	if tween.xory=="x" then
		tween.obj.x=rbl__fflr(tween.obj.x+tween.steps);
	elseif tween.xory=="y" then
		tween.obj.y=rbl__fflr(tween.obj.y+tween.steps);
	end
	printh("steps:"..tween.steps)
	printh("obj.x:"..tween.obj.x..";obj.y:"..tween.obj.y)
	
	tween.obj.col=flr(tween.obj.x/8)
	tween.obj.row=flr(tween.obj.y/8)
	printh("3>>"..tween.obj.col..";"..tween.obj.row)
end

function _update()
	if btnp(0) then
		control_player(1,-1,0)
	elseif btnp(1) then
	 control_player(1,1,0)
	elseif btnp(2) then
		control_player(1,0,-1)
	elseif btnp(3) then
		control_player(1,0,1)
	end
	
	foreach(tweens,handle_tween)
end

function draw_actor(a)
	local sx=(a.x)
	local sy=(a.y)
	spr(a.spr, sx, sy)
end

function _draw()
	cls()
	map(0,0,0,0,16,16)
	foreach(tiles,draw_actor)
	foreach(players,draw_actor)
end
-->8
function make_tween(a,xory,target,seconds)
	local tween={}
	
	tween.obj=a
	tween.xory=xory
	
	local current=nil
	if xory=="x" then
		current=a.x
	elseif xory=="y" then
		current=a.y
	end
	if target>current then
		tween.direction=1
	elseif target<current then
		tween.direction=-1
	else
		rbl__error("target should not be equal to current")
		return
	end
	printh("-4>>"..tween.direction..";"..current..";"..target)
	tween.steps=(target-current)*seconds
	printh("-3>>"..tween.steps..";"..current..";"..target..";"..seconds)
	tween.target=target
	add(tweens,tween)
	return tween
end

function tween__handle_reached(tween)
	local to_check=nil
	if tween.xory=="x" then
		to_check=tween.obj.x
	else
		to_check=tween.obj.y
	end
	if (tween.direction > 0 
			and to_check >= tween.target) 
		or (tween.direction < 0	
			and to_check <= tween.target)
	 then
		if tween.xory=="x" then
			tween.obj.x=tween.target
		else
			tween.obj.y=tween.target
		end
		printh("3.5>>"..tween.obj.x..";"..tween.obj.y)
		local t=tile_at(tween.obj.col,tween.obj.row)
		printh("4>>finding tile at:"..tween.obj.col..";"..tween.obj.row..";"..t.col..";"..t.row)
		attach(tween.obj,t)
	
		del(tweens,tween)
		printh("tweendestroyed:"..#tweens)		
		return true
	end
	return false
end
-->8
function rbl__fflr(num)
	return flr(num*100)/100
end

function rbl__error(message)
	printh(">>> error: "..message)
end
__gfx__
00000000090000900000000000ee8e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000099999999000000000e8eeee0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
007007009990909900000000eeeee8e5000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0007700099999999000000004e8eee54000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000999999990000000044444445000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700999999990000000004444440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000004994000000000004444450000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000999000000000005555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000006666660b333333b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000600000063000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000600000063000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000600000063000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000600000063000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000600000063000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000600000063000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000006666660b333333b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
1111111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1100000000000000000000000000001100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1100000000000000000000000000001100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1100000000000000000000000000001100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1100000000000000000000000000001100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1100000000000000000000000000001100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1100000000000000000000000000001100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1100000000000000000000000000001100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1100000000000000000000000000001100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1100000000000000000000000000001100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1100000000000000000000000000001100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1100000000000000000000000000001100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1100000000000000000000000000001100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1100000000000000000000000000001100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1100000000000000000000000000001100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
011200000c0500c0500c05010050120501005010050120500c0500c0500c05010050120501005010050120500c0500c0500c05010050120501005010050120500c0500c0500c0501005012050100501005012050
011000000c350113501a350173501a350173501735010030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__music__
00 00014344

